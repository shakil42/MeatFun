<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Usage Reports - SHAGOR</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .report-container { padding: 30px; max-width: 1200px; margin: auto; min-height: 80vh; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-top: 5px solid #10b981; }
        .stat-card .value { font-size: 1.8rem; font-weight: bold; color: #0f172a; }
        
        .report-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 40px; }
        .report-table th { background: #f8fafc; padding: 15px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #475569; font-size: 13px; }
        .report-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; color: #1e293b; font-size: 14px; }
        
        .filter-bar { background: white; padding: 20px; border-radius: 12px; display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .filter-group input, .filter-group select { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; }

        .btn-group { display: flex; gap: 10px; }
        .btn-print { background: #6366f1; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-save { background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* FOOTER FOR CLEAR BUTTON */
        .report-footer { 
            margin-top: 50px; 
            padding-top: 20px; 
            border-top: 1px dashed #cbd5e1; 
            display: flex; 
            justify-content: center; 
        }
        .btn-clear { 
            background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; font-size: 13px;
            transition: all 0.2s;
        }
        .btn-clear:hover { background: #ef4444; color: white; }

        @media print {
            .navbar, .filter-bar, .btn-group, .report-footer, .no-print { display: none !important; }
            .report-container { padding: 0; }
            .stat-card { border: 1px solid #ddd; box-shadow: none; }
        }
    </style>
</head>
<body>

    <nav class="navbar no-print">
        <div class="nav-logo">SHAGOR Meat Track</div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="production-log.html">Production LOG</a></li>
            <li><a href="reports.html" class="active">Reports</a></li>
        </ul>
    </nav>

    <div class="report-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h1>Usage Report</h1>
                <p id="printDateRange" style="color: #64748b; font-size: 14px;"></p>
            </div>
            <div class="btn-group no-print">
                <button class="btn-save" onclick="exportReportCSV()">
                    <span class="material-icons">download</span> Save CSV
                </button>
                <button class="btn-print" onclick="window.print()">
                    <span class="material-icons">print</span> Print PDF
                </button>
            </div>
        </div>
        
        <div class="filter-bar no-print">
            <div class="filter-group">
                <label>From Date</label>
                <input type="date" id="dateFrom" onchange="loadReportData()">
            </div>
            <div class="filter-group">
                <label>To Date</label>
                <input type="date" id="dateTo" onchange="loadReportData()">
            </div>
            <div class="filter-group">
                <label>Category</label>
                <select id="filterCat" onchange="loadReportData()">
                    <option value="All">All Categories</option>
                    <option value="Chicken">Chicken</option>
                    <option value="Beef">Beef</option>
                </select>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><h3>Produced</h3><div class="value" id="statCooked">0 kg</div></div>
            <div class="stat-card" style="border-top-color: #ef4444;"><h3>Total Used</h3><div class="value" id="statUsed" style="color:#ef4444;">0 kg</div></div>
            <div class="stat-card" style="border-top-color: #3b82f6;"><h3>Current Net</h3><div class="value" id="statNet" style="color:#3b82f6;">0 kg</div></div>
        </div>

        <table class="report-table" id="reportTable">
            <thead>
                <tr>
                    <th>Prod. Date</th>
                    <th>Usage Date</th>
                    <th>Batch</th>
                    <th>Product</th>
                    <th>Cooked</th>
                    <th>Used</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody id="reportItems"></tbody>
        </table>

        <div class="report-footer no-print">
            <button class="btn-clear" onclick="handleClearAll()">
                <span class="material-icons">delete_forever</span>
                Clear All Database Records
            </button>
        </div>
    </div>

    <script>
        // ... (loadReportData and exportReportCSV functions remain the same as previous)
        function loadReportData() {
            const data = JSON.parse(localStorage.getItem("shagor_meat_reports")) || { "Chicken": [], "Beef": [], "Rice": [] };
            const fromDate = document.getElementById('dateFrom').value;
            const toDate = document.getElementById('dateTo').value;
            const selectedCat = document.getElementById('filterCat').value;
            const tbody = document.getElementById('reportItems');
            
            document.getElementById('printDateRange').innerText = `Period: ${fromDate || 'Start'} to ${toDate || 'End'}`;

            tbody.innerHTML = "";
            let totalProduced = 0;
            let totalUsed = 0;

            Object.keys(data).forEach(cat => {
                if (selectedCat === "All" || selectedCat === cat) {
                    data[cat].forEach((entry) => {
                        const compareDate = entry.usageDate || entry.date;
                        if (fromDate && compareDate < fromDate) return;
                        if (toDate && compareDate > toDate) return;

                        const cooked = parseFloat(entry.cooked) || 0;
                        const used = parseFloat(entry.openBag) || 0;
                        const balance = cooked - used;

                        totalProduced += cooked;
                        totalUsed += used;

                        tbody.innerHTML += `
                            <tr>
                                <td>${entry.date}</td>
                                <td style="color:#3b82f6; font-weight:bold;">${entry.usageDate || '-'}</td>
                                <td>${entry.batch}</td>
                                <td>${entry.product}</td>
                                <td style="color:green">+${cooked.toFixed(2)}</td>
                                <td style="color:red">-${used.toFixed(2)}</td>
                                <td>${balance.toFixed(2)} kg</td>
                            </tr>
                        `;
                    });
                }
            });

            document.getElementById('statCooked').innerText = totalProduced.toFixed(1) + " kg";
            document.getElementById('statUsed').innerText = totalUsed.toFixed(1) + " kg";
            document.getElementById('statNet').innerText = (totalProduced - totalUsed).toFixed(1) + " kg";
        }

        function exportReportCSV() {
            let csv = "Prod Date,Usage Date,Batch,Product,Cooked,Used,Balance\n";
            const rows = document.querySelectorAll("#reportItems tr");
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                csv += Array.from(cols).map(c => c.innerText.replace("kg", "").trim()).join(",") + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `Usage_Report_${new Date().toISOString().split('T')[0]}.csv`);
            a.click();
        }

        window.onload = () => {
            const now = new Date();
            const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('dateTo').value = now.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = lastWeek.toISOString().split('T')[0];
            loadReportData();
        };

        function handleClearAll() {
            if(confirm("DANGER: This will permanently delete ALL records from the system. Continue?")) {
                localStorage.removeItem("shagor_meat_reports");
                loadReportData();
            }
        }
    </script>
</body>
</html>
